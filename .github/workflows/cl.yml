name: cl

on:
  push:
    branches:
      - '*'
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: ps2dev/ps2dev:latest
    steps:
      - name: Install dependencies
        run: apk add --no-cache build-base git p7zip python3 nodejs npm

      - uses: actions/checkout@v4
      - name: Configure git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git fetch --prune --unshallow || true

      - name: Compute metadata
        id: meta
        run: echo "short_sha=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Enumerate variants
        run: make list-variants > variants.json

      - name: Build all variants
        env:
          SHORT_SHA: ${{ steps.meta.outputs.short_sha }}
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json, os, shlex, subprocess, sys

          with open("variants.json", "r", encoding="utf-8") as fh:
              variants = json.load(fh).get("include", [])

          if not variants:
              sys.exit("No variants produced by list-variants")

          for entry in variants:
              name = entry["name"]
              flags = entry.get("flags", "").strip()
              outdir = os.path.join("build", "variants", name)
              base = ["make", f"VARIANT={name}", f"OUTDIR={outdir}", f"COMMIT_HASH={os.environ['SHORT_SHA']}"]
              if flags:
                  base += shlex.split(flags)
              subprocess.run(base + ["clean"], check=True)
              subprocess.run(base + ["all"], check=True)
              cfg = os.path.join(outdir, "BUILD_CONFIG.txt")
              if not os.path.isfile(cfg):
                  sys.exit(f"Missing BUILD_CONFIG.txt for {name}")
          PY

      - name: Upload artifacts
        env:
          SHORT_SHA: ${{ steps.meta.outputs.short_sha }}
        run: |
          set -euo pipefail
          npm install @actions/artifact
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');
          const artifact = require('@actions/artifact');

          const root = path.join(process.cwd(), 'build', 'variants');
          if (!fs.existsSync(root)) {
            throw new Error('build/variants does not exist');
          }

          const client = artifact.create();

          const walk = (dir) => {
            return fs.readdirSync(dir, { withFileTypes: true }).flatMap((entry) => {
              const full = path.join(dir, entry.name);
              return entry.isDirectory() ? walk(full) : [full];
            });
          };

          (async () => {
            const entries = fs.readdirSync(root, { withFileTypes: true }).filter((d) => d.isDirectory());
            for (const entry of entries) {
              const variantRoot = path.join(root, entry.name);
              const files = walk(variantRoot);
              if (!files.length) continue;
              await client.uploadArtifact(`ps2bbl-${entry.name}-${process.env.SHORT_SHA}`, files, variantRoot, {
                continueOnError: false
              });
            }
          })().catch((err) => {
            console.error(err);
            process.exit(1);
          });
          NODE

  prerelease:
    needs: build
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          pattern: ps2bbl-*

      - name: Archive artifacts
        run: |
          mkdir -p release-packages
          for dir in release-artifacts/*; do
            [ -d "$dir" ] || continue
            base=$(basename "$dir")
            tar -czf "release-packages/${base}.tar.gz" -C "$dir" .
          done

      - name: Prepare release notes
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          {
            echo "Automated CL prerelease for ${GITHUB_SHA}"
            echo
            echo "Artifacts:"
            for file in release-packages/*; do
              echo "- $(basename "$file")"
            done
          } > RELEASE_BODY.md

      - name: Publish prerelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: cl-${{ github.sha }}
          name: CL prerelease ${{ github.sha }}
          body_path: RELEASE_BODY.md
          prerelease: true
          overwrite: true
          files: release-packages/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
