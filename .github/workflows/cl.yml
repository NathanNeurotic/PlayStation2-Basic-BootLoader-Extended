name: cl

on:
  push:
    branches:
      - '*'
  pull_request:
  workflow_dispatch:

jobs:
  matrix:
    runs-on: ubuntu-latest
    container: ps2dev/ps2dev:latest
    outputs:
      variants: ${{ steps.variants.outputs.matrix }}
      variant_count: ${{ steps.variants.outputs.variant_count }}
    steps:
      - name: Install dependencies
        run: apk add --no-cache build-base git p7zip python3

      - uses: actions/checkout@v4
      - name: Configure git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git fetch --prune --unshallow || true

      - name: Generate variant matrix
        id: variants
        env:
          CHUNK_SIZE: 25
        run: |
          set -euo pipefail
          make list-variants > variants.json
          python3 - <<'PY' > matrix.json
import json, os

CHUNK_SIZE = int(os.environ.get("CHUNK_SIZE", "25"))
with open("variants.json", "r", encoding="utf-8") as fh:
    variants = json.load(fh).get("include", [])

batches = []
for idx in range(0, len(variants), CHUNK_SIZE):
    batch = variants[idx : idx + CHUNK_SIZE]
    batches.append({"index": idx // CHUNK_SIZE, "batch": json.dumps(batch)})

print(json.dumps({"include": batches}, sort_keys=False))
print(json.dumps({"count": len(variants)}, sort_keys=False), file=open("count.json", "w"))
PY
          echo "variant_count=$(jq -r '.count' count.json)" >> "$GITHUB_OUTPUT"
          echo "matrix<<EOF" >> "$GITHUB_OUTPUT"
          cat matrix.json >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

  build:
    needs: matrix
    runs-on: ubuntu-latest
    container: ps2dev/ps2dev:latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.matrix.outputs.variants) }}
    steps:
      - name: Install dependencies
        run: apk add --no-cache build-base git p7zip python3 nodejs npm

      - uses: actions/checkout@v4
      - name: Configure git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git fetch --prune --unshallow || true

      - name: Compute metadata
        id: meta
        run: echo "short_sha=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Build batch ${{ matrix.index }}
        env:
          BATCH_JSON: ${{ matrix.batch }}
          SHORT_SHA: ${{ steps.meta.outputs.short_sha }}
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json, os, shlex, subprocess, sys

          batch = json.loads(os.environ["BATCH_JSON"])
          short_sha = os.environ["SHORT_SHA"]

          for entry in batch:
              name = entry["name"]
              flags = entry.get("flags", "").strip()
              outdir = os.path.join("build", "variants", name)
              base = ["make", f"VARIANT={name}", f"OUTDIR={outdir}", f"COMMIT_HASH={short_sha}"]
              if flags:
                  base += shlex.split(flags)
              subprocess.run(base + ["clean"], check=True)
              subprocess.run(base + ["all"], check=True)
              cfg = os.path.join(outdir, "BUILD_CONFIG.txt")
              if not os.path.isfile(cfg):
                  raise SystemExit(f"Missing BUILD_CONFIG.txt for {name}")
          PY

      - name: Upload batch ${{ matrix.index }}
        env:
          BATCH_JSON: ${{ matrix.batch }}
          SHORT_SHA: ${{ steps.meta.outputs.short_sha }}
        run: |
          set -euo pipefail
          npm install @actions/artifact
          node - <<'NODE'
          const artifact = require('@actions/artifact');
          const fs = require('fs');
          const path = require('path');

          const batch = JSON.parse(process.env.BATCH_JSON);
          const client = artifact.create();

          const walk = (dir) => {
            return fs.readdirSync(dir, { withFileTypes: true }).flatMap((entry) => {
              const full = path.join(dir, entry.name);
              return entry.isDirectory() ? walk(full) : [full];
            });
          };

          (async () => {
            for (const entry of batch) {
              const name = entry.name;
              const outdir = path.join('build', 'variants', name);
              if (!fs.existsSync(outdir)) {
                throw new Error(`build output missing for ${name}`);
              }
              const files = walk(outdir);
              if (!files.length) {
                throw new Error(`no files to upload for ${name}`);
              }
              await client.uploadArtifact(`ps2bbl-${name}-${process.env.SHORT_SHA}`, files, outdir, {
                continueOnError: false
              });
            }
          })().catch((err) => {
            console.error(err);
            process.exit(1);
          });
          NODE

  prerelease:
    needs: build
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          pattern: ps2bbl-*

      - name: Archive artifacts
        run: |
          mkdir -p release-packages
          for dir in release-artifacts/*; do
            [ -d "$dir" ] || continue
            base=$(basename "$dir")
            tar -czf "release-packages/${base}.tar.gz" -C "$dir" .
          done

      - name: Prepare release notes
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          {
            echo "Automated CL prerelease for ${GITHUB_SHA}"
            echo
            echo "Artifacts:"
            for file in release-packages/*; do
              echo "- $(basename "$file")"
            done
          } > RELEASE_BODY.md

      - name: Publish prerelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: cl-${{ github.sha }}
          name: CL prerelease ${{ github.sha }}
          body_path: RELEASE_BODY.md
          prerelease: true
          overwrite: true
          files: release-packages/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
